uiTransmit:
	CALL	_ENT_PARM_DIRECT_L09
	BIT	1,(IX+8)
	JR	Z,_0001
_0000:
	LD	L,(IX+10)
	LD	H,(IX+11)
	PUSH	HL
	CALL	uiXModemCRC16
	POP	AF
	LD	(IX+10),L
	LD	(IX+11),H
_0001:
	LD	C,(IX+4)
	LD	B,(IX+5)
	LD	E,(IX+2)
	LD	D,(IX+3)
	CALL	vJIOTransmit
	XOR	A
	OR	(IX+12)
	JR	Z,_0003
	BIT	1,(IX+8)
	JR	Z,_0003
_0005:
_0004:
_0002:
	LD	BC,2
	LD	HL,10
	ADD	HL,SP
	EX	DE,HL
	CALL	vJIOTransmit
_0003:
	LD	L,(IX+10)
	LD	H,(IX+11)
	JP	_LEAVE_DIRECT_L09
ucReceive:
	CALL	_ENT_PARM_DIRECT_L09
_0039:
_0007:
	LD	C,(IX+4)
	LD	B,(IX+5)
	LD	E,(IX+2)
	LD	D,(IX+3)
	CALL	bJIOReceive
	OR	A
	JR	NZ,_0006
_0008:
	BIT	2,(IX+8)
	JR	Z,_0039
_0009:
	LD	A,3
	JR	_0011
_0010:
_0006:
	XOR	A
_0011:
	JP	_LEAVE_DIRECT_L09
ucReadOrWriteSectors:
	CALL	_ENT_AUTO_DIRECT_L09
	DEFW	65510
	PUSH	IY
	LD	HL,W_FLAGS
	LD	C,(IX+12)
	LD	B,(IX+13)
	ADD	HL,BC
	LD	D,(HL)
	LD	(IX-4),D
	LD	HL,W_COMMAND
	ADD	HL,BC
	LD	B,(HL)
	LD	IYH,B
	LD	(IX-18),74
	LD	(IX-17),73
	LD	(IX-16),79
	LD	(IX-15),D
	LD	HL,36
	ADD	HL,SP
	INC	HL
	LD	B,(HL)
	DEC	HL
	LD	(HL),B
	LD	C,(IX+4)
	LD	B,(IX+5)
	LD	L,(IX+2)
	LD	H,(IX+3)
	LD	(IX-13),L
	LD	(IX-12),H
	LD	(IX-11),C
	LD	(IX-10),B
	LD	B,(IX+8)
	LD	(IX-9),B
	LD	L,(IX+10)
	LD	H,(IX+11)
	LD	(IX-8),L
	LD	(IX-7),H
	LD	L,B
	LD	H,L
	LD	L,0
	ADD	HL,HL
	LD	(IX-26),L
	LD	(IX-25),H
_0014:
	LD	B,IYH
	LD	(IX-14),B
	LD	A,IYH
	CP	18
	JR	NZ,_0041
	LD	A,1
	JR	_0042
_0041:
	XOR	A
_0042:
	LD	C,A
	PUSH	BC
	LD	HL,0
	PUSH	HL
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,5
	LD	L,16
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	A,IYH
	CP	17
	JR	NZ,_0016
_0015:
	LD	C,0
	PUSH	BC
	PUSH	HL
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,7
	LD	HL,21
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	C,1
	PUSH	BC
	PUSH	HL
	LD	L,(IX-4)
	PUSH	HL
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,2
	LD	HL,28
	ADD	HL,SP
	EX	DE,HL
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0020
_0017:
	LD	HL,4369
	LD	C,(IX-2)
	LD	B,(IX-1)
	AND	A
	SBC	HL,BC
	JR	Z,_0020
_0019:
	LD	HL,13107
	AND	A
	SBC	HL,BC
	JR	NZ,_0022
	LD	A,1
	JR	_0023
_0022:
	LD	A,11
_0023:
	LD	IYL,A
_0020:
_0018:
	JR	_0034
_0016:
	CP	16
	JR	NZ,_0026
_0025:
	LD	C,1
	PUSH	BC
	PUSH	HL
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,7
	LD	HL,21
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
_0026:
	LD	L,(IX-4)
	PUSH	HL
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0034
	BIT	0,(IX-4)
	JR	Z,_0034
_0030:
_0029:
_0027:
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,2
	LD	HL,6
	ADD	HL,SP
	EX	DE,HL
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0034
_0031:
	LD	L,A
	LD	H,A
	PUSH	HL
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	uiXModemCRC16
	POP	AF
	LD	C,(IX-24)
	LD	B,(IX-23)
	AND	A
	SBC	HL,BC
	JR	Z,_0034
_0033:
	LD	IYL,5
_0034:
_0032:
_0028:
_0024:
	LD	B,IYL
	INC	B
	DEC	B
	JR	Z,_0036
_0035:
	LD	(IX-14),B
	LD	C,1
	PUSH	BC
	LD	HL,0
	PUSH	HL
	LD	L,(IX-4)
	PUSH	HL
	LD	BC,5
	LD	L,16
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
_0036:
	LD	B,IYL
	INC	B
	DEC	B
	JR	Z,_0012
	BIT	3,(IX-4)
	JP	NZ,_0014
_0012:
	LD	A,IYL
	POP	IY
	JP	_LEAVE_DIRECT_L09
