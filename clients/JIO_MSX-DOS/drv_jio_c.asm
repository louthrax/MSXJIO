vWaitForSmallBufferModules:
	PUSH	DE
	LD	DE,1024
_0001:
	LD	A,E
	OR	D
	JR	Z,_0000
_0002:
	DEC	DE
	JR	_0001
_0000:
	POP	DE
	RET
uiTransmit:
	CALL	_ENT_AUTO_DIRECT_L09
	DEFW	65532
	PUSH	IY
	LD	E,C
	LD	D,B
	LD	L,(IX+2)
	LD	H,(IX+3)
	LD	(IX-4),L
	LD	(IX-3),H
	BIT	1,(IX+8)
	JR	Z,_0005
_0004:
	PUSH	DE
	LD	L,(IX+10)
	LD	H,(IX+11)
	PUSH	HL
	LD	E,(IX+2)
	LD	D,(IX+3)
	CALL	uiXModemCRC16
	POP	AF
	LD	(IX+10),L
	LD	(IX+11),H
	POP	DE
_0005:
_0007:
	LD	A,E
	OR	D
	JR	Z,_0006
_0008:
	LD	HL,40
	SBC	HL,DE
	JR	NC,_0010
	LD	HL,40
	JR	_0011
_0010:
	LD	L,E
	LD	H,D
_0011:
	PUSH	HL
	POP	IY
	BIT	4,(IX+8)
	JR	Z,_0013
_0012:
	CALL	vWaitForSmallBufferModules
_0013:
	PUSH	DE
	PUSH	IY
	POP	BC
	LD	E,(IX-4)
	LD	D,(IX-3)
	CALL	vJIOTransmit
	POP	DE
	PUSH	IY
	POP	BC
	LD	L,C
	LD	H,B
	AND	A
	EX	DE,HL
	SBC	HL,DE
	EX	DE,HL
	LD	HL,2
	ADD	HL,SP
	LD	A,(HL)
	ADD	A,C
	LD	(HL),A
	INC	HL
	LD	A,(HL)
	ADC	A,B
	LD	(HL),A
	JR	_0005
_0006:
	OR	(IX+12)
	JR	Z,_0015
	BIT	1,(IX+8)
	JR	Z,_0015
_0017:
_0016:
_0014:
	BIT	4,(IX+8)
	JR	Z,_0019
_0018:
	CALL	vWaitForSmallBufferModules
_0019:
	LD	BC,2
	LD	HL,16
	ADD	HL,SP
	EX	DE,HL
	CALL	vJIOTransmit
_0015:
	LD	L,(IX+10)
	LD	H,(IX+11)
	POP	IY
	JP	_LEAVE_DIRECT_L09
ucReceive:
	CALL	_ENT_PARM_DIRECT_L09
_0072:
_0021:
	LD	C,(IX+4)
	LD	B,(IX+5)
	LD	E,(IX+2)
	LD	D,(IX+3)
	CALL	bJIOReceive
	OR	A
	JR	NZ,_0020
_0022:
	BIT	2,(IX+8)
	JR	Z,_0072
_0023:
	LD	A,3
	JR	_0025
_0024:
_0020:
	XOR	A
_0025:
	JP	_LEAVE_DIRECT_L09
ucDoCommand:
	CALL	_ENT_AUTO_DIRECT_L09
	DEFW	65510
	PUSH	IY
	LD	HL,W_FLAGS
	LD	C,(IX+12)
	LD	B,(IX+13)
	ADD	HL,BC
	LD	D,(HL)
	LD	IYH,D
	LD	HL,W_COMMAND
	ADD	HL,BC
	LD	B,(HL)
	LD	(IX-4),B
	LD	(IX-18),74
	LD	(IX-17),73
	LD	(IX-16),79
	LD	(IX-15),D
	LD	HL,36
	ADD	HL,SP
	INC	HL
	LD	B,(HL)
	DEC	HL
	LD	(HL),B
	LD	C,(IX+4)
	LD	B,(IX+5)
	LD	L,(IX+2)
	LD	H,(IX+3)
	LD	(IX-13),L
	LD	(IX-12),H
	LD	(IX-11),C
	LD	(IX-10),B
	LD	B,(IX+8)
	LD	(IX-9),B
	LD	L,(IX+10)
	LD	H,(IX+11)
	LD	(IX-8),L
	LD	(IX-7),H
	LD	L,B
	LD	H,L
	LD	L,0
	ADD	HL,HL
	LD	(IX-26),L
	LD	(IX-25),H
_0028:
	LD	B,(IX-4)
	LD	(IX-14),B
	LD	A,B
	CP	18
	JR	Z,_0030
	CP	19
	JR	Z,_0030
	XOR	A
	JR	_0031
_0030:
	LD	A,1
_0031:
	LD	C,A
	PUSH	BC
	LD	HL,0
	PUSH	HL
	LD	C,IYH
	PUSH	BC
	LD	BC,5
	LD	L,16
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	A,(IX-4)
	CP	19
	JR	NZ,_0033
_0032:
	LD	C,IYH
	PUSH	BC
	LD	BC,2
	LD	HL,27
	ADD	HL,SP
	EX	DE,HL
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0041
_0034:
	LD	HL,17476
	LD	C,(IX-3)
	LD	B,(IX-2)
	AND	A
	SBC	HL,BC
	JR	NZ,_0037
_0036:
	LD	IYL,20
	JR	_0041
_0037:
	LD	HL,21845
	AND	A
	SBC	HL,BC
	JR	NZ,_0040
_0039:
	LD	IYL,21
	JR	_0041
_0040:
	LD	IYL,5
_0041:
_0038:
_0035:
	JP	_0065
_0033:
	CP	17
	JR	NZ,_0044
_0043:
	LD	C,0
	PUSH	BC
	PUSH	HL
	LD	C,IYH
	PUSH	BC
	LD	BC,7
	LD	HL,21
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	C,1
	PUSH	BC
	PUSH	HL
	LD	C,IYH
	PUSH	BC
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
	LD	C,IYH
	PUSH	BC
	LD	BC,2
	LD	HL,27
	ADD	HL,SP
	EX	DE,HL
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0054
_0045:
	LD	HL,8738
	LD	C,(IX-3)
	LD	B,(IX-2)
	AND	A
	SBC	HL,BC
	JR	NZ,_0048
_0047:
	LD	HL,13107
	AND	A
	SBC	HL,BC
	JR	NZ,_0050
	LD	A,1
	JR	_0051
_0050:
	LD	A,11
_0051:
	LD	IYL,A
	JR	_0065
_0048:
	LD	HL,4369
	AND	A
	SBC	HL,BC
	JR	Z,_0065
_0053:
	LD	IYL,5
_0054:
_0052:
_0046:
	JR	_0065
_0044:
	CP	16
	JR	NZ,_0057
_0056:
	LD	C,1
	PUSH	BC
	PUSH	HL
	LD	C,IYH
	PUSH	BC
	LD	BC,7
	LD	HL,21
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
_0057:
	LD	C,IYH
	PUSH	BC
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0065
	LD	B,IYH
	BIT	0,B
	JR	Z,_0065
_0061:
_0060:
_0058:
	LD	C,IYH
	PUSH	BC
	LD	BC,2
	LD	HL,6
	ADD	HL,SP
	EX	DE,HL
	CALL	ucReceive
	POP	HL
	LD	IYL,A
	OR	A
	JR	NZ,_0065
_0062:
	LD	L,A
	LD	H,A
	PUSH	HL
	LD	C,(IX-26)
	LD	B,(IX-25)
	LD	E,(IX+10)
	LD	D,(IX+11)
	CALL	uiXModemCRC16
	POP	AF
	LD	C,(IX-24)
	LD	B,(IX-23)
	AND	A
	SBC	HL,BC
	JR	Z,_0065
_0064:
	LD	IYL,5
_0065:
_0063:
_0059:
_0055:
_0042:
	LD	B,IYL
	INC	B
	DEC	B
	JR	Z,_0067
	LD	A,IYL
	CP	20
	JR	Z,_0067
	CP	21
	JR	Z,_0067
_0069:
_0068:
_0066:
	LD	(IX-14),B
	LD	C,1
	PUSH	BC
	LD	HL,0
	PUSH	HL
	LD	C,IYH
	PUSH	BC
	LD	BC,5
	LD	L,16
	ADD	HL,SP
	EX	DE,HL
	CALL	uiTransmit
	POP	AF
	POP	AF
	POP	AF
_0067:
	LD	B,IYL
	INC	B
	DEC	B
	JR	Z,_0026
	LD	A,IYL
	CP	20
	JR	Z,_0026
	CP	21
	JR	Z,_0026
	LD	B,IYH
	BIT	3,B
	JP	NZ,_0028
_0026:
	LD	A,IYL
	POP	IY
	JP	_LEAVE_DIRECT_L09
